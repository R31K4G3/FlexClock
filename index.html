<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <title>FlexClock</title>
        <style type="text/css">
            input, select {
                background: #323339;
                color: #FFF;
            }
        </style>
    </head>
    <body style="background: #323339; color: #FFF; margin: 0px; padding: 0.3rem; font-family: sans-serif;">
        <h1 style="margin: 0px; padding: 0.3rem;">Clock</h1>
        <div style="padding: 0.3rem; text-align: center;">
            <span id="time-output" style="font-family: monospace; font-size: 24px;">HH:MM:SS</span>
        </div>
        <div style="max-width: 100%; max-height: 80svh; text-align: center; position: relative;">
            <canvas id="clock-dial-canvas" width="4096" height="4096" style="max-width: 100%; max-height: 80svh; position: absolute; top: 0px;"></canvas>
            <canvas id="clock-hand-canvas" width="4096" height="4096" style="max-width: 100%; max-height: 80svh; position: relative; top: 0px; left: 0px;"></canvas>
        </div>
        <div style="border: 1px solid #55636f; border-radius: 8.5px; padding: 0.3rem; max-width: 60rem; margin: 0px auto;">
            <h2 style="margin: 0px; padding: 0.3rem;">Config</h2>
            <div style="padding: 0.3rem;">
                <form onsubmit="return false" style="margin: 0px; padding: 0px;">
                    <div><span>whether use "0" for zero hour(midnight) : </span><input id="zero-mode" type="checkbox"></div>
                    <div><span>counter-clockwise mode : </span><input id="counter-clockwise-mode" type="checkbox"></div>
                    <div><span>hour format : </span><select id="hour-format">
                        <option value="decimal">base-10 digits</option>
                        <option value="n-base-up">base-N digits (uppercase)</option>
                        <option value="n-base-low">base-N digits (lowercase)</option>
                        <option value="undef">"undefined"</option>
                        <option value="nan">NaN (Not a Number)</option>
                    </select></div>
                    <div><span>round(s) / day : </span><span id="display-rpd"></span><input id="rounds-per-day" type="range" min="1" max="8" value="2" style="width: 100%; margin: 0px;"></div>
                    <div><span>hour(s) / round : </span><span id="display-hpr"></span><input id="hours-per-round" type="range" min="1" max="32" value="12" style="width: 100%; margin: 0px;"></div>
                    <div><span>minute(s) / hour : </span><span id="display-mph"></span><input id="minutes-per-hour" type="range" min="1" max="128" value="60" style="width: 100%; margin: 0px;"></div>
                    <div><span>second(s) / minute : </span><span id="display-spm"></span><input id="seconds-per-minute" type="range" min="1" max="128" value="60" style="width: 100%; margin: 0px;"></div>
                    <br>
                    <div><input id="reset-button" type="reset" value="Reset All Params"></div>
                </form>
            </div>
        </div>
        <script type="module">
            const displayRpd = document.getElementById("display-rpd");
            const displayHpr = document.getElementById("display-hpr");
            const displayMph = document.getElementById("display-mph");
            const displaySpm = document.getElementById("display-spm");
            const roundsPerDay = document.getElementById("rounds-per-day");
            const hoursPerRound = document.getElementById("hours-per-round");
            const minutesPerHour = document.getElementById("minutes-per-hour");
            const secondsPerMinute = document.getElementById("seconds-per-minute");
            const zeroMode = document.getElementById("zero-mode");
            const counterClockwiseMode = document.getElementById("counter-clockwise-mode")
            const hourFormat = document.getElementById("hour-format");
            const resetButton = document.getElementById("reset-button");
            const timeDisplay = document.getElementById("time-output");
            const clockDialCanvas = document.getElementById("clock-dial-canvas");
            const clockDialCanvasContext = clockDialCanvas.getContext("2d");
            const clockHandCanvas = document.getElementById("clock-hand-canvas");
            const clockHandCanvasContext = clockHandCanvas.getContext("2d");
            roundsPerDay.addEventListener("input", onConfigUpdate);
            hoursPerRound.addEventListener("input", onConfigUpdate);
            minutesPerHour.addEventListener("input", onConfigUpdate);
            secondsPerMinute.addEventListener("input", onConfigUpdate);
            hourFormat.addEventListener("input", onConfigUpdate);
            zeroMode.addEventListener("input", onConfigUpdate);
            counterClockwiseMode.addEventListener("input", onConfigUpdate);
            resetButton.addEventListener("mouseup", () => {
                resetButton.click();
                onConfigUpdate();
            });
            onConfigUpdate();
            ~async function() {
                for (;;) {
                    await new Promise(r => requestAnimationFrame(r));
                    updateClockHandsAndTimeDisplay();
                }
            }();

            function onConfigUpdate() {
                updateClockDial();
                displayRpd.textContent = roundsPerDay.value;
                displayHpr.textContent = hoursPerRound.value;
                displayMph.textContent = minutesPerHour.value;
                displaySpm.textContent = secondsPerMinute.value;
            }
            function expi(theta) {
                return [Math.cos(theta), Math.sin(theta)];
            }
            function updateClockDial() {
                // clear canvas
                clockDialCanvasContext.clearRect(0, 0, clockDialCanvas.width, clockDialCanvas.height);

                // draw circle
                clockDialCanvasContext.strokeStyle = "#FFFFFF";
                clockDialCanvasContext.lineWidth = 10;
                clockDialCanvasContext.beginPath();
                clockDialCanvasContext.arc(clockDialCanvas.width / 2, clockDialCanvas.height / 2, 0.95 * (clockDialCanvas.width / 2), 0, 2 * Math.PI);
                clockDialCanvasContext.stroke();

                // draw disk
                clockDialCanvasContext.fillStyle = "#FFFFFF";
                clockDialCanvasContext.lineWidth = 17;
                clockDialCanvasContext.beginPath();
                clockDialCanvasContext.arc(clockDialCanvas.width / 2, clockDialCanvas.height / 2, 0.03 * (clockDialCanvas.width / 2), 0, 2 * Math.PI);
                clockDialCanvasContext.stroke();

                // draw clock dial
                const sgn = counterClockwiseMode.checked ? 1 : -1;
                for (const i of new Array(+hoursPerRound.value).keys()) {
                    const { 0: y, 1: x } = expi(sgn * (i / hoursPerRound.value) * 2 * Math.PI);
                    const r = 0.81 * (clockDialCanvas.width / 2);
                    clockDialCanvasContext.font = "270px sans-serif";
                    clockDialCanvasContext.fillStyle = "#FFFFFF";
                    clockDialCanvasContext.textAlign = "center";
                    clockDialCanvasContext.textBaseline = "middle";
                    const n = zeroMode.checked ? i : (i || +hoursPerRound.value);
                    const nStr = {
                        __proto__: null,
                        decimal: () => `${n}`,
                        "n-base-up": () => n.toString(36).toUpperCase(),
                        "n-base-low": () => n.toString(36).toLowerCase(),
                        undef: () => "undefined",
                        nan: () => "NaN"
                    }[hourFormat.value]();
                    clockDialCanvasContext.fillText(nStr, clockDialCanvas.width / 2 - r * x, 40 + clockDialCanvas.width / 2 - r * y);
                }
                for (const i of new Array(+minutesPerHour.value).keys()) {
                    const { 0: y, 1: x } = expi(sgn * (i / minutesPerHour.value) * 2 * Math.PI);
                    const innerR = 0.92 * (clockDialCanvas.width / 2);
                    const outerR = 0.95 * (clockDialCanvas.width / 2);
                    clockDialCanvasContext.beginPath();
                    clockDialCanvasContext.moveTo(clockDialCanvas.width / 2 - innerR * x, clockDialCanvas.height / 2 - innerR * y);
                    clockDialCanvasContext.lineTo(clockDialCanvas.width / 2 - outerR * x, clockDialCanvas.height / 2 - outerR * y);
                    clockDialCanvasContext.lineWidth = 25;
                    clockDialCanvasContext.stroke();
                }
                if (secondsPerMinute.value !== minutesPerHour.value) {
                    for (const i of new Array(+secondsPerMinute.value).keys()) {
                        const { 0: y, 1: x } = expi(sgn * (i / secondsPerMinute.value) * 2 * Math.PI);
                        const innerR = 0.905 * (clockDialCanvas.width / 2);
                        const outerR = 0.95 * (clockDialCanvas.width / 2);
                        clockDialCanvasContext.beginPath();
                        clockDialCanvasContext.moveTo(clockDialCanvas.width / 2 - innerR * x, clockDialCanvas.height / 2 - innerR * y);
                        clockDialCanvasContext.lineTo(clockDialCanvas.width / 2 - outerR * x, clockDialCanvas.height / 2 - outerR * y);
                        clockDialCanvasContext.lineWidth = 10;
                        clockDialCanvasContext.stroke();
                    }
                }
            }
            function drawHand(p, length, lineWidth, minusLength) {
                const sgn = counterClockwiseMode.checked ? 1 : -1;
                const { 0: y, 1: x } = expi(sgn * p * 2 * Math.PI);
                const r = length * (clockHandCanvas.width / 2);
                const mr = minusLength * (clockHandCanvas.width / 2);
                clockHandCanvasContext.beginPath();
                clockHandCanvasContext.moveTo(clockHandCanvas.width / 2 + mr * x, clockHandCanvas.height / 2 + mr * y);
                clockHandCanvasContext.lineTo(clockHandCanvas.width / 2 - r * x, clockHandCanvas.width / 2 - r * y);
                clockHandCanvasContext.strokeStyle = "#FFFFFF";
                clockHandCanvasContext.lineWidth = lineWidth;
                clockHandCanvasContext.stroke();
            }
            function updateClockHandsAndTimeDisplay() {
                // clear canvas
                clockHandCanvasContext.clearRect(0, 0, clockHandCanvas.width, clockHandCanvas.height);

                // draw clock hands
                const now = new Date();
                const beginningOfDay = new Date(now.getTime());
                beginningOfDay.setUTCHours(0, 0, 0, 0);
                const timeZoneOffset = 0.375;
                const progressOfDay = (now.getTime() - beginningOfDay.getTime()) / 86400000;
                let p = progressOfDay;
                p += timeZoneOffset;
                p %= 1.0;
                p *= roundsPerDay.value;
                const rounds = Math.floor(p);
                p %= 1.0;
                drawHand(p, 0.55, 50, 0.04);
                p *= hoursPerRound.value;
                const hours = Math.floor(p);
                p %= 1.0;
                drawHand(p, 0.75, 30, 0.065);
                p *= minutesPerHour.value;
                const minutes = Math.floor(p);
                p %= 1.0;
                const seconds = Math.floor(p * secondsPerMinute.value);
                drawHand(p, 0.85, 15, 0.15);

                // set HH:MM:SS
                const normal = () => `${(rounds * hoursPerRound.value + hours).toString().padStart((roundsPerDay.value * hoursPerRound.value).toString().length, "0")}:${minutes.toString().padStart((minutesPerHour.value - 1).toString().length, "0")}:${seconds.toString().padStart((secondsPerMinute.value - 1).toString().length, "0")}`;
                timeDisplay.textContent = {
                    __proto__: null,
                    decimal: normal,
                    "n-base-up": normal,
                    "n-base-low": normal,
                    undef: () => "undefined:undefined:undefined",
                    nan: () => "NaN:NaN:NaN"
                }[hourFormat.value]();
            }
        </script>
    </body>
</html>