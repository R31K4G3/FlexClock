<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <title>FlexClock</title>
        <style type="text/css">
            input, select {
                background: #323339;
                color: #FFF;
            }
        </style>
    </head>
    <body style="background: #323339; color: #FFF; margin: 0px; padding: 0.3rem; font-family: sans-serif;">
        <h1 style="margin: 0px; padding: 0.3rem;">Clock</h1>
        <div style="padding: 0.3rem; text-align: center;">
            <span id="time-output" style="font-family: monospace; font-size: 24px;">HH:MM:SS</span>
        </div>
        <div style="text-align: center;">
            <canvas id="clock-canvas" width="4096" height="4096" style="max-width: 100%; max-height: 80svh;"></canvas>
        </div>
        <div style="border: 1px solid #55636f; border-radius: 8.5px; padding: 0.3rem; max-width: 60rem;">
            <h2 style="margin: 0px; padding: 0.3rem;">Config</h2>
            <div style="padding: 0.3rem;">
                <form onsubmit="return false" style="margin: 0px; padding: 0px;">
                    <div><span>whether use "0" for zero hour(midnight) : </span><input id="zero-mode" type="checkbox"></div>
                    <div><span>hour format : </span><select id="hour-format">
                        <option value="decimal">decimal digits</option>
                        <option value="n-base-up">base-N digits (uppercase)</option>
                        <option value="n-base-low">base-N digits (lowercase)</option>
                    </select></div>
                    <div><span>round(s) / day : </span><span id="display-rpd"></span><input id="rounds-per-day" type="range" min="1" max="8" value="2" style="width: 100%; margin: 0px;"></div>
                    <div><span>hour(s) / round : </span><span id="display-hpr"></span><input id="hours-per-round" type="range" min="1" max="32" value="12" style="width: 100%; margin: 0px;"></div>
                    <div><span>minute(s) / hour : </span><span id="display-mph"></span><input id="minutes-per-hour" type="range" min="1" max="128" value="60" style="width: 100%; margin: 0px;"></div>
                    <div><span>second(s) / minute : </span><span id="display-spm"></span><input id="seconds-per-minute" type="range" min="1" max="128" value="60" style="width: 100%; margin: 0px;"></div>
                    <br>
                    <div><input id="reset-button" type="reset" value="Reset All Params"></div>
                </form>
            </div>
        </div>
        <script type="module">
            const displayRpd = document.getElementById("display-rpd");
            const displayHpr = document.getElementById("display-hpr");
            const displayMph = document.getElementById("display-mph");
            const displaySpm = document.getElementById("display-spm");
            const roundsPerDay = document.getElementById("rounds-per-day");
            const hoursPerRound = document.getElementById("hours-per-round");
            const minutesPerHour = document.getElementById("minutes-per-hour");
            const secondsPerMinute = document.getElementById("seconds-per-minute");
            const zeroMode = document.getElementById("zero-mode");
            const hourFormat = document.getElementById("hour-format");
            const resetButton = document.getElementById("reset-button");
            const timeDisplay = document.getElementById("time-output");
            const clockCanvas = document.getElementById("clock-canvas");
            const clockCanvasContext = clockCanvas.getContext("2d");
            roundsPerDay.addEventListener("input", updateConfigDisplay);
            hoursPerRound.addEventListener("input", updateConfigDisplay);
            minutesPerHour.addEventListener("input", updateConfigDisplay);
            secondsPerMinute.addEventListener("input", updateConfigDisplay);
            resetButton.addEventListener("mouseup", () => {
                resetButton.click();
                updateConfigDisplay();
            });
            updateConfigDisplay();
            ~async function() {
                for (;;) {
                    await new Promise(r => requestAnimationFrame(r));
                    updateClockCanvas();
                }
            }();

            function updateConfigDisplay() {
                displayRpd.textContent = roundsPerDay.value;
                displayHpr.textContent = hoursPerRound.value;
                displayMph.textContent = minutesPerHour.value;
                displaySpm.textContent = secondsPerMinute.value;
            }
            function expi(theta) {
                return [Math.cos(theta), Math.sin(theta)];
            }
            function drawDial() {
                // draw circle
                clockCanvasContext.strokeStyle = "#FFFFFF";
                clockCanvasContext.lineWidth = 10;
                clockCanvasContext.beginPath();
                clockCanvasContext.arc(clockCanvas.width / 2, clockCanvas.height / 2, 0.95 * (clockCanvas.width / 2), 0, 2 * Math.PI); //
                clockCanvasContext.stroke();

                // draw clock dial
                for (const i of new Array(+hoursPerRound.value).keys()) {
                    const { 0: y, 1: x } = expi(-(i / hoursPerRound.value) * 2 * Math.PI);
                    const r = 0.84 * (clockCanvas.width / 2);
                    clockCanvasContext.font = "210px sans-serif";
                    clockCanvasContext.fillStyle = "#FFFFFF";
                    clockCanvasContext.textAlign = "center";
                    clockCanvasContext.textBaseline = "middle";
                    const n = zeroMode.checked ? i : (i || +hoursPerRound.value);
                    const nStr = { decimal: `${n}`, "n-base-up": n.toString(36).toUpperCase(), "n-base-low": n.toString(36).toLowerCase() }[hourFormat.value];
                    clockCanvasContext.fillText(nStr, clockCanvas.width / 2 - r * x, 30 + clockCanvas.width / 2 - r * y);
                }
                for (const i of new Array(+minutesPerHour.value).keys()) {
                    const { 0: y, 1: x } = expi(-(i / minutesPerHour.value) * 2 * Math.PI);
                    const innerR = 0.92 * (clockCanvas.width / 2);
                    const outerR = 0.95 * (clockCanvas.width / 2);
                    clockCanvasContext.beginPath();
                    clockCanvasContext.moveTo(clockCanvas.width / 2 - innerR * x, clockCanvas.height / 2 - innerR * y);
                    clockCanvasContext.lineTo(clockCanvas.width / 2 - outerR * x, clockCanvas.height / 2 - outerR * y);
                    clockCanvasContext.lineWidth = 25;
                    clockCanvasContext.stroke();
                }
                if (secondsPerMinute.value !== minutesPerHour.value) {
                    for (const i of new Array(+secondsPerMinute.value).keys()) {
                        const { 0: y, 1: x } = expi(-(i / secondsPerMinute.value) * 2 * Math.PI);
                        const innerR = 0.905 * (clockCanvas.width / 2);
                        const outerR = 0.95 * (clockCanvas.width / 2);
                        clockCanvasContext.beginPath();
                        clockCanvasContext.moveTo(clockCanvas.width / 2 - innerR * x, clockCanvas.height / 2 - innerR * y);
                        clockCanvasContext.lineTo(clockCanvas.width / 2 - outerR * x, clockCanvas.height / 2 - outerR * y);
                        clockCanvasContext.lineWidth = 10;
                        clockCanvasContext.stroke();
                    }
                }
            }
            function drawHand(p, length, lineWidth) {
                const { 0: y, 1: x } = expi(-p * 2 * Math.PI);
                const r = length * (clockCanvas.width / 2);
                clockCanvasContext.beginPath();
                clockCanvasContext.moveTo(clockCanvas.width / 2, clockCanvas.height / 2);
                clockCanvasContext.lineTo(clockCanvas.width / 2 - r * x, clockCanvas.width / 2 - r * y);
                clockCanvasContext.lineWidth = lineWidth;
                clockCanvasContext.stroke();
            }
            function updateClockCanvas() {
                // clear canvas
                clockCanvasContext.clearRect(0, 0, clockCanvas.width, clockCanvas.height);

                drawDial();

                // draw clock hands
                const now = new Date();
                const beginningOfDay = new Date(now.getTime());
                beginningOfDay.setUTCHours(0, 0, 0, 0);
                const timeZoneOffset = 0.375;
                const progressOfDay = (now.getTime() - beginningOfDay.getTime()) / 86400000;
                let p = progressOfDay;
                p += timeZoneOffset;
                p %= 1.0;
                p *= roundsPerDay.value;
                const rounds = Math.floor(p);
                p %= 1.0;
                drawHand(p, 0.55, 50);
                p *= hoursPerRound.value;
                const hours = Math.floor(p);
                p %= 1.0;
                drawHand(p, 0.75, 30);
                p *= minutesPerHour.value;
                const minutes = Math.floor(p);
                p %= 1.0;
                const seconds = Math.floor(p * secondsPerMinute.value);
                drawHand(p, 0.85, 15);

                // set HH:MM:SS
                timeDisplay.textContent = `${(rounds * hoursPerRound.value + hours).toString().padStart((roundsPerDay.value * hoursPerRound.value).toString().length, "0")}:${minutes.toString().padStart((minutesPerHour.value - 1).toString().length, "0")}:${seconds.toString().padStart((secondsPerMinute.value - 1).toString().length, "0")}`;
            }
        </script>
    </body>
</html>